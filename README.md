# Little Sister Tableland


## Usage

First, clone this repo:

```sh
git clone https://github.com/LittleSisters/little-sisters-node.git
```

### Build & deploy

To simply compile contracts, you can install dependencies with 
```
npm install
```
and then run:

```
npm run build
```

To install packages, compile contracts, and also startup Local Tableland and Hardhat nodes, run the following:

```
npm run up
```

This will keep the nodes running until you exit the session. While this is running, you can then choose to deploy the contracts to these local networks by opening a new terminal window and running:

```
npm run deploy:up
```

Configure .env file with your credentials. Copy env.example to .env and fill in LIGHTHOUSE_API_KEY. 
You may not need to fill in other variables if you are not going to use other networks.
```
LIGHTHOUSE_API_KEY=

SISTERS_CONTRACT=0xDc64a140Aa3E981100a9becA4E685f962f0cF6C9
TBL_PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
TBL_CHAIN=local-tableland
TBL_PROVIDER_URL=http://127.0.0.1:8545/

# test nets
FILECOIN_CALIBRATION_PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
```

To obtain a Lighthouse API key install CLI tool https://docs.lighthouse.storage/lighthouse-1/cli-tool/overview
```
npm install -g @lighthouse-web3/sdk
lighthouse-web3 import-wallet --key <private_key>
lighthouse-web3 api-key --new
```

Check `recorder.config.json` for cameras configuration. You can find another open cameras on the internet
https://www.google.com/search?q=inurl%3Amjpg%2Fvideo.mjpg

* `recordings_directory` - directory where recordings will be stored
* `seg` - segment duration in seconds (30 seconds for testing purposes, in real life it can be from hour to day)
* `cmd` - for now  ffmpeg used to store recordings, but it can be changed to any other tool, or proxied with [mediamtx](https://github.com/bluenviron/mediamtx). 
File names must be "cameraID_unixTimeStampStart_unixTimeStampEnd.ext" i.e. "cam1_1634170800_1634171100.mp4" to be properly processed.
* `cameras` - array of cameras to record from. These parameters substituted to ffmpeg command. Also, these parameters saved to the `evts` table. 
* * `id` - id
* * `src` - source url
* * `adr` - address
* * `gps` - gps coordinates


Run Little Sisters node:
```
npm run sister
```

It will start 
1. recording from the cameras 
2. uploading the recordings to the LightHouse
3. adding the recordings to the local Tableland
4. in future video files will be AI processed (locally or using Lillypad) and found events will be added to the Tableland.


### Testing

For full test coverage, run the following, which will show statement, branch, function, and line coverage (see `index.html` located in the `coverage` directory):

```
npm test
```

You can see gas costs associated with each contract method:

```
npm run test:gas
```

### Formatting & cleanup

Remove untracked files and directories, such as those that were autogenerated:

```
npm run clean
```

Format and lint the project:

```
npm run format
```

### Extracting the ABI and bytecode

You can grab the assets you need by compiling the contracts and then using some [`jq`](https://jqlang.github.io/jq/) magic:

#### ABI

```shell
cat artifacts/contracts/Starter.sol/Starter.json | jq '.abi' > abi.json
```

#### Bytecode

```shell
cat artifacts/contracts/Starter.sol/Starter.json | jq -r '.bytecode' > bytecode.bin
```

### Contract verification

To perform contract verification on Etherscan and other block explorers, you first need to deploy a contract to a live network, such as Sepolia:

```shell
npx hardhat run scripts/deploy.ts --network sepolia
```

Then, copy the logged deployment address and replace `DEPLOYED_CONTRACT_ADDRESS` with this value in the command below:

```shell
npx hardhat verify DEPLOYED_CONTRACT_ADDRESS --network sepolia
```

## Contributing

PRs accepted.

Small note: If editing the README, please conform to the
[standard-readme](https://github.com/RichardLitt/standard-readme) specification.

## License

MIT AND Apache-2.0,
© 2023 Bogdoslavik
© 2021-2023 Tableland Network Contributors
